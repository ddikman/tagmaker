<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
        <script src="./jspdf.min.js"></script>
        <script src="./svg2pdf.min.js"></script>
        <link rel="stylesheet" href="./tagmaker.css" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <script src="./localizations.js"></script>
    </head>
    <body>
            <div id="file-input">
                <div>
                        <label data-translate="upload-hint">Press to upload data file</label>
                </div>
                <div style="margin-top: 20px">
                    <label for="files" class="button -green" data-translate="choose-file">Choose file</label>
                    <input type="file" id="files" name="file" />
                </div>
                <div>
                    <a class="button -blue" href='test.csv' data-translate="download-example" download="example.csv">Download example file</a>
                </div>
            </div>
              <div id="output" style="display: none;">
                <svg id="svg" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1400 1000" version="1.1">
                    <g id="example">
                        <path class="stroke" stroke-width="0.21600001" stroke="#373535" fill="none" d="m 10,58.5758 h 211.8747 c 4.0966,0 7.4486,-3.3516 7.4486,-7.4486 v -41.7957 c 0,-4.0969 -3.352,-7.4486 -7.4486,-7.4486 H 10 c -4.0967,0 -7.4484,3.3517 -7.4484,7.4486 v 41.7957 c 0,4.097 3.3517,7.4486 7.4484,7.4486 z"></path>
                        <path class="stroke" stroke-width="0.21600001" stroke="#373535" fill="none" d="m 218.5222,36.2564 c 3.1312,0 5.6693,-2.5384 5.6693,-5.6693 0,-3.1308 -2.5381,-5.6693 -5.6693,-5.6693 -3.1311,0 -5.6693,2.5385 -5.6693,5.6693 0,3.1309 2.5382,5.6693 5.6693,5.6693 z"></path>
                        <path class="stroke" stroke-width="0.21600001" stroke="#373535" fill="none" d="m 15.0083,36.2564 c 3.1311,0 5.6693,-2.5384 5.6693,-5.6693 0,-3.1308 -2.5382,-5.6693 -5.6693,-5.6693 -3.1312,0 -5.6693,2.5385 -5.6693,5.6693 0,3.1309 2.5381,5.6693 5.6693,5.6693 z"></path>
                    </g>
            </svg>
        </div>

        <div id="done-buttons" style="display: none;">
            <a class="button -green" id="download-svg-link" data-translate='download-svg'>Download SVG</a>
            <a class="button -green" id="download-pdf-link" data-translate='download-pdf'>Download PDF</a>
            <a class="button -blue" href="#" id="try-again" data-translate="try-again">Try again</a>
        </div>

        <div id="created-by">
            <p>Copyright 2019 David Dikman, <a href="https://greycastle.se">https://greycastle.se</a></p>
            <p><a href="https://github.com/ddikman/tagmaker">https://github.com/ddikman/tagmaker</a></p>
        </div>
        </div>

        <script>
            const snap = Snap('#svg'); 

            function generateSvg(rows) {
                $('#output').show();
                const maxColumns = 7;
                
                let row = 0;
                let column = 0;
                let offsetX = 0;
                let offsetY = 0;
                let count = 0;
                rows.forEach(function(row) {
                    if (column == maxColumns) {
                        column = 0;
                        offsetY = offsetY + 70;
                        offsetX = 0;
                    }
                    place(row, offsetX, offsetY)

                    offsetX += 240;
                    column += 1;
                })

                // remove the original one
                Snap('#example').remove()

                // scale back
                const totalBox = snap.getBBox();
                snap.attr({
                    viewBox: `0 0 ${totalBox.width + 10} ${totalBox.height + 10}`
                })

                const svg = $('#svg')[0];
                const base64 = base64EncodeUnicode(svg.outerHTML);
                $('#download-svg-link').attr('href', "data:application/svg;base64," + base64);
                $('#download-svg-link').attr('download', 'template.svg');

                const pdf = new jsPDF();
                pdf.addFont('Arial.ttf', 'Arial', 'Normal')

                // render the svg element
                svg2pdf(document.getElementById('svg'), pdf, {
                    xOffset: 50,
                    yOffset: 50,
                    scale: 1
                });

                // get the data URI
                $('#download-pdf-link').attr('href', pdf.output('datauristring'));
                $('#download-pdf-link').attr('download', 'template.pdf');
            }

            function centeredTextBox(container, rows) {
                const lineHeight = 20;
                const offsetY = 23;
                rows.forEach(function(line, index) {
                    const middle = container.getBBox().width * 0.5;
                    const text = snap.text(middle, 0, line);
                    text.addClass('text');
                    container.append(text);
                    text.attr({
                        'font-family': 'Arial',
                        'font-size': '14pt',
                        'font-weight': 'bold',
                        'text-anchor': 'middle',
                        y: offsetY + lineHeight * index
                    });
                });
            }

            function centerText(container, text) {
                const bbox = container.getBBox();
                centeredTextBox(container, text)
            }

            function place(text, x, y) {
                const box = Snap('#example').clone();
                box.transform(`t${x},${y}`);
                snap.append(box);
                centerText(box, text)
            }

            function base64EncodeUnicode(str) {
                // First we escape the string using encodeURIComponent to get the UTF-8 encoding of the characters, 
                // then we convert the percent encodings into raw bytes, and finally feed it to btoa() function.
                utf8Bytes = encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                        return String.fromCharCode('0x' + p1);
                });

                return btoa(utf8Bytes);
            }
        </script>

        <script>

    function readData(file, callback) {
    var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = function(e) {
          callback(reader.result);
      }

      // Read in the image file as a data URL.
      reader.readAsText(file);
    }

    function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for (var i = 0, f; f = files[i]; i++) {

        if (f.name.endsWith('csv')) {
            console.log('reading file')
            readData(f, function(data) {
                // console.log(data);
                rows = data.split('\n').map(function(row) { return row.split(',')});
                generateSvg(rows);
                $('#done-buttons').show();
                $('#file-input').hide();
            })
        }
    }
  }

  $('#try-again').click(function() {
    window.location.reload();
  });

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  </script>
    </body>
</html>